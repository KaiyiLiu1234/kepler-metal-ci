---
- name: Create Kubernetes Cluster on Equinix Metal
  hosts: localhost
  vars:
    metal_api_token: "{{ lookup('env', 'METAL_AUTH_TOKEN') }}" 
    project_id: "{{ lookup('env', 'EQUINIX_PROJECT_ID') }}"
    control_plane_count: 1
    node_count: 1
    operating_system: "rhel_9"
    plan: "c3.small.x86"
    facility: "da"
    # cluster_id: "cluster-{{ 999 | random }}"
    cluster_id: "cluster-"
    ssh_key_path: /root/.ssh/kepler_ci

  tasks:
    - name: Download metal CLI
      shell: curl -L https://github.com/equinix/metal-cli/releases/download/v0.23.0/metal-linux-amd64 -o /usr/bin/metal

    - name: Make metal CLI executable
      shell: chmod 755 /usr/bin/metal

    - name: Create metal config
      shell: |
        cat <<EOF > /tmp/metal.yaml
        token: "{{ metal_api_token }}"
        project-id: "{{ project_id }}"
        EOF
    
    - name: Check if the control plane servers already exist
      shell: metal device list --config /tmp/metal.yaml --output json | jq -r '.[] | select(.hostname | contains("{{ cluster_id }}-control-plane-{{ item }}")) | .id'
      loop: "{{ range(1, control_plane_count|int + 1)|list }}"
      register: existing_control_plane_servers
      failed_when: false

    - name: Print control_plane_servers
      debug:
        msg: "{{ existing_control_plane_servers }}"

    - name: Create Control Plane Servers if they do not exist
      when: existing_control_plane_servers == ""
      shell: >
        metal device create
        --config /tmp/metal.yaml
        --hostname "{{ cluster_id }}-control-plane-{{ item }}"
        --plan "{{ plan }}"
        --operating-system "{{ operating_system }}"
        --metro "{{ facility }}" 
        --output json 
        | jq -r '.id'
      loop: "{{ range(1, control_plane_count|int + 1)|list }}"
      register: control_plane_servers

    - name: Set existing_control_plane_servers to control_plane_servers, if existing control plane servers exist
      when: existing_control_plane_servers != ""
      set_fact:
        control_plane_servers: "{{ existing_control_plane_servers }}"

    - name: Check if the node servers already exist
      shell: metal device list --config /tmp/metal.yaml --output json | jq -r '.[] | select(.hostname | contains("{{ cluster_id }}-node-{{ item }}")) | .id'
      loop: "{{ range(1, control_plane_count|int + 1)|list }}"
      register: existing_node_servers
      failed_when: false

    - name: Create Node Servers if they do not exist, don't overwrite the existing control_plane_servers variable
      when: existing_node_servers == ""
      shell: >
        metal device create
        --config /tmp/metal.yaml
        --hostname "{{ cluster_id }}-node-{{ item }}"
        --operating-system "{{ operating_system }}"
        --plan "{{ plan }}"
        --metro "{{ facility }}"
        --output json 
        | jq -r '.id'
      loop: "{{ range(1, node_count|int + 1)|list }}"
      register: node_servers

    - name: Set existing_node_servers to node_servers, if existing node servers exist
      when: existing_node_servers != ""
      set_fact:
        node_servers: "{{ existing_node_servers }}"

    - name: Print control_plane_servers
      debug:
        msg: "{{ control_plane_servers }}"

    - name: Wait for Control Plane Servers to be Active
      shell: metal device get -i {{ item.stdout }} --config /tmp/metal.yaml --output json | jq -r '.state'
      register: control_plane_status
      until: control_plane_status.stdout.find('active') != -1
      retries: 10
      delay: 30
      loop: "{{ control_plane_servers.results }}"
      failed_when: false

    - name: Print Node Servers
      debug:
        msg: "{{ node_servers }}"

    - name: Wait for Node Servers to be Active
      shell: metal device get -i {{ item.stdout }} --config /tmp/metal.yaml --output json | jq -r '.state'
      register: node_status
      until: node_status.stdout.find('active') != -1
      retries: 10
      delay: 30
      loop: "{{ node_servers.results }}"
      failed_when: false

    - name: Add Control Plane Servers to Inventory
      add_host:
        name: "{{ item.stdout }}"
        groups: control_plane
      loop: "{{ control_plane_servers.results }}"

    - name: Add Node Servers to Inventory
      add_host:
        name: "{{ item.stdout }}"
        groups: nodes
      loop: "{{ node_servers.results }}"

    - name: Get IP addresses of control plane node
      shell: metal device get -i {{ item.stdout }} --config /tmp/metal.yaml --output json | jq -r '.ip_addresses[0].address'
      register: control_ip_addresses
      loop: "{{ control_plane_servers.results}}"

    - name: Get IP addresses of node
      shell: metal device get -i {{ item.stdout }} --config /tmp/metal.yaml --output json | jq -r '.ip_addresses[0].address'
      register: node_ip_addresses
      loop: "{{ node_servers.results }}"

    - name: Print Control Plane IP addresses
      debug:
        msg: "{{ control_ip_addresses.results | map(attribute='stdout') | list }}"

    - name: Print Node IP addresses
      debug:
        msg: "{{ node_ip_addresses.results | map(attribute='stdout') | list }}"

    - name: Delete metal config
      shell: rm /tmp/metal.yaml

- name: Provision Kubernetes Cluster
  hosts: control_ip_addresses
  become: yes

  tasks:
    - name: Set SELinux to Permissive
      shell: setenforce 0

    - name: add yum repo
      shell: |
          # This overwrites any existing configuration in /etc/yum.repos.d/kubernetes.repo
          cat <<EOF | sudo tee /etc/yum.repos.d/kubernetes.repo
          [kubernetes]
          name=Kubernetes
          baseurl=https://pkgs.k8s.io/core:/stable:/v1.30/rpm/
          enabled=1
          gpgcheck=1
          gpgkey=https://pkgs.k8s.io/core:/stable:/v1.30/rpm/repodata/repomd.xml.key
          exclude=kubelet kubeadm kubectl cri-tools kubernetes-cni
          EOF
    - name: Install kubeadm and dependencies
      yum:
        name:
          - kubeadm
          - kubectl
          - kubelet
        state: present

    - name: Start and enable kubelet service
      service:
        name: kubelet
        state: started
        enabled: yes

    - name: Initialize Kubernetes Cluster on Control Plane
      command: kubeadm init
      when: inventory_hostname in groups['control_plane']

    - name: Join Nodes to Kubernetes Cluster
      command: kubeadm join --token "{{ hostvars[groups['control_plane'][0]]['kubeadm_token'] }}"
      when: inventory_hostname in groups['nodes']